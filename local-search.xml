<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Terraform 系列一 在AWS上创建VPC</title>
    <link href="/posts/6f066d48.html"/>
    <url>/posts/6f066d48.html</url>
    
    <content type="html"><![CDATA[<h2 id="Terraform-系列一-在AWS上创建VPC"><a href="#Terraform-系列一-在AWS上创建VPC" class="headerlink" title="Terraform 系列一 在AWS上创建VPC"></a>Terraform 系列一 在AWS上创建VPC</h2><p><img src="/./images/Terraform%20%E7%B3%BB%E5%88%97%E4%B8%80%20%E5%9C%A8AWS%E4%B8%8A%E5%88%9B%E5%BB%BAVPC/terraform-que-es-20241104141746764.png" alt="Terraform: Discover Its Benefits For Your Company Cloud"></p><h3 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h3><p>在AWS上创建VPC，VPC启用三个可用区，每个可用区包含Private，Public subnet各一个，一个NAT Gateway，一个Internet Gateway</p><h3 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a>创建资源</h3><p>新建 variables.tf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs hcl">provider &quot;aws&quot; &#123;<br>  region = var.region<br>  access_key = var.access_key<br>  secret_key = var.secret_key<br>&#125;<br><br>variable &quot;region&quot; &#123; # 根据需要更改区域<br>  type        = string<br>  default     = &quot;xxx&quot;<br>  description = &quot;region&quot;<br>&#125;<br><br>variable &quot;access_key&quot; &#123;<br>  type        = string<br>  default     = &quot;xxx&quot;<br>  description = &quot;access_key&quot;<br>&#125;<br><br>variable &quot;secret_key&quot; &#123;<br>  type        = string<br>  default     = &quot;xxx&quot;<br>  description = &quot;secret_key&quot;<br>&#125;<br><br>variable &quot;vpc_cidr&quot; &#123;<br>  type        = string<br>  default     = &quot;10.0.0.0/16&quot;<br>  description = &quot;vpc &quot;<br>&#125;<br><br>variable &quot;vpc_subnet_public1_cidr&quot; &#123;<br>  type        = string<br>  default     = &quot;10.0.0.0/22&quot;<br>  description = &quot;vpc_subnet_public1_cidr&quot;<br>&#125;<br><br>variable &quot;vpc_subnet_public2_cidr&quot; &#123;<br>  type        = string<br>  default     = &quot;10.0.4.0/22&quot;<br>  description = &quot;vpc_subnet_public2_cidr&quot;<br>&#125;<br><br>variable &quot;vpc_subnet_private1_cidr&quot; &#123;<br>  type        = string<br>  default     = &quot;10.0.8.0/22&quot;<br>  description = &quot;vpc_subnet_private1_cidr&quot;<br>&#125;<br><br>variable &quot;vpc_subnet_private2_cidr&quot; &#123;<br>  type        = string<br>  default     = &quot;10.0.12.0/22&quot;<br>  description = &quot;vpc_subnet_private2_cidr&quot;<br>&#125;<br></code></pre></td></tr></table></figure><p>新建vpc.tf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs hcl"># 创建 VPC<br>resource &quot;aws_vpc&quot; &quot;vpc&quot; &#123;<br>  cidr_block           = var.vpc_cidr<br>  enable_dns_support   = true<br>  enable_dns_hostnames = true<br><br>  tags = &#123;<br>    Name = &quot;vpc&quot;<br>  &#125;<br>&#125;<br><br># 创建公有子网<br>resource &quot;aws_subnet&quot; &quot;vpc_subnet_public1&quot; &#123;<br>  vpc_id            = aws_vpc.vpc.id<br>  cidr_block        = var.vpc_subnet_public1_cidr<br>  availability_zone = format(&quot;%s%s&quot;, var.region, &quot;a&quot;)  # 根据需要更改可用区<br><br>  tags = &#123;<br>    Name = &quot;public_subnet_1a&quot;<br>  &#125;<br>&#125;<br><br>resource &quot;aws_subnet&quot; &quot;vpc_subnet_public2&quot; &#123;<br>  vpc_id            = aws_vpc.vpc.id<br>  cidr_block        = var.vpc_subnet_public2_cidr<br>  availability_zone = format(&quot;%s%s&quot;, var.region, &quot;b&quot;)  # 根据需要更改可用区<br><br>  tags = &#123;<br>    Name = &quot;public_subnet_2b&quot;<br>  &#125;<br>&#125;<br><br># 创建私有子网<br>resource &quot;aws_subnet&quot; &quot;vpc_subnet_private1&quot; &#123;<br>  vpc_id            = aws_vpc.vpc.id<br>  cidr_block        = var.vpc_subnet_private1_cidr<br>  availability_zone = format(&quot;%s%s&quot;, var.region, &quot;a&quot;)  # 根据需要更改可用区<br><br>  tags = &#123;<br>    Name = &quot;private_subnet_2a&quot;<br>  &#125;<br>&#125;<br><br>resource &quot;aws_subnet&quot; &quot;vpc_subnet_private2&quot; &#123;<br>  vpc_id            = aws_vpc.vpc.id<br>  cidr_block        = var.vpc_subnet_private2_cidr<br>  availability_zone = format(&quot;%s%s&quot;, var.region, &quot;b&quot;)  # 根据需要更改可用区<br><br>  tags = &#123;<br>    Name = &quot;private_subnet_2b&quot;<br>  &#125;<br>&#125;<br><br># 创建互联网网关<br>resource &quot;aws_internet_gateway&quot; &quot;vpc_internet_gateway&quot; &#123;<br>  vpc_id = aws_vpc.vpc.id<br><br>  tags = &#123;<br>    Name = &quot;igw&quot;<br>  &#125;<br>&#125;<br><br># 创建 NAT 网关的弹性 IP<br>resource &quot;aws_eip&quot; &quot;vpc_nat_eip&quot; &#123;<br>  domain = &quot;vpc&quot;<br>  depends_on = [<br>    aws_internet_gateway.vpc_internet_gateway<br>  ]<br>&#125;<br><br># 创建 NAT 网关<br>resource &quot;aws_nat_gateway&quot; &quot;vpc_nat_gateway&quot; &#123;<br>  allocation_id = aws_eip.vpc_nat_eip.id<br>  subnet_id     = aws_subnet.vpc_subnet_public1.id  # 公有子网中的任意一个<br>  <br>  tags = &#123;<br>    Name = &quot;nat_gateway&quot;<br>  &#125;<br>&#125;<br><br># 创建公有子网路由表<br>resource &quot;aws_route_table&quot; &quot;vpc_public_router_table&quot; &#123;<br>  vpc_id = aws_vpc.vpc.id<br><br>  route &#123;<br>    cidr_block = &quot;0.0.0.0/0&quot;<br>    gateway_id = aws_internet_gateway.vpc_internet_gateway.id<br>  &#125;<br><br>  tags = &#123;<br>    Name = &quot;public_route_table&quot;<br>  &#125;<br>&#125;<br><br># 将公有子网关联到公有子网路由表<br>resource &quot;aws_route_table_association&quot; &quot;public_subnet_1&quot; &#123;<br>  subnet_id      = aws_subnet.vpc_subnet_public1.id<br>  route_table_id = aws_route_table.vpc_public_router_table.id<br>&#125;<br><br>resource &quot;aws_route_table_association&quot; &quot;public_subnet_2&quot; &#123;<br>  subnet_id      = aws_subnet.vpc_subnet_public2.id<br>  route_table_id = aws_route_table.vpc_public_router_table.id<br>&#125;<br><br># 创建私有子网路由表<br>resource &quot;aws_route_table&quot; &quot;vpc_private_router_table&quot; &#123;<br>  vpc_id = aws_vpc.vpc.id<br><br>  route &#123;<br>    cidr_block     = &quot;0.0.0.0/0&quot;<br>    nat_gateway_id = aws_nat_gateway.vpc_nat_gateway.id<br>  &#125;<br><br>  tags = &#123;<br>    Name = &quot;private_route_table&quot;<br>  &#125;<br>&#125;<br><br># 将私有子网关联到私有子网路由表<br>resource &quot;aws_route_table_association&quot; &quot;private_subnet_1&quot; &#123;<br>  subnet_id      = aws_subnet.vpc_subnet_private1.id<br>  route_table_id = aws_route_table.vpc_private_router_table.id<br>&#125;<br><br>resource &quot;aws_route_table_association&quot; &quot;private_subnet_2&quot; &#123;<br>  subnet_id      = aws_subnet.vpc_subnet_private2.id<br>  route_table_id = aws_route_table.vpc_private_router_table.id<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">terraform init<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看预期变更</span><br>terraform plan<br><span class="hljs-meta prompt_"># </span><span class="language-bash">生效变更</span><br>terraform apply<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>运维</category>
      
    </categories>
    
    
    <tags>
      
      <tag>terraform</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafka批量修改Topic副本</title>
    <link href="/posts/aed030e0.html"/>
    <url>/posts/aed030e0.html</url>
    
    <content type="html"><![CDATA[<h2 id="Kafka-批量修改topic副本"><a href="#Kafka-批量修改topic副本" class="headerlink" title="Kafka 批量修改topic副本"></a>Kafka 批量修改topic副本</h2><h3 id="列出副本为1的topic"><a href="#列出副本为1的topic" class="headerlink" title="列出副本为1的topic"></a>列出副本为1的topic</h3><p>topic.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">topics=`/opt/server/kafka/bin/kafka-topics.sh --zookeeper 192.168.25.123:2181 -list`<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$topics</span>;<span class="hljs-keyword">do</span><br>  replicsNum=`/opt/server/kafka/bin/kafka-topics.sh --zookeeper 192.168.25.123:2181 -describe --topic <span class="hljs-variable">$i</span>|grep ReplicationFactor|awk <span class="hljs-string">&#x27;&#123;print$3&#125;&#x27;</span>|awk -F: <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$replicsNum</span> == 1 ];<span class="hljs-keyword">then</span><br>     <span class="hljs-built_in">echo</span>  <span class="hljs-variable">$i</span> &gt;&gt; /opt/server/kafka/bin/topic.txt<br>  <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h3 id="leaders-txt"><a href="#leaders-txt" class="headerlink" title="leaders.txt"></a>leaders.txt</h3><p>填写broker id</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs txt">1<br>2<br>3<br></code></pre></td></tr></table></figure><h3 id="生成topic配置json"><a href="#生成topic配置json" class="headerlink" title="生成topic配置json"></a>生成topic配置json</h3><p>topic-reassignment.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>ZK_HOST=<span class="hljs-string">&quot;192.168.25.123:2181&quot;</span><br><br>topics=`<span class="hljs-built_in">cat</span> ./topic.txt`<br><br>IFS=$<span class="hljs-string">&#x27;\n&#x27;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#x27;</span> &gt; topic-reassignment.json<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$topics</span>;<span class="hljs-keyword">do</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;write file for &#x27;</span><span class="hljs-variable">$i</span><span class="hljs-string">&#x27;&#x27;</span><br>  leaders=`./kafka-topics.sh --zookeeper <span class="hljs-variable">$ZK_HOST</span> -describe --topic <span class="hljs-variable">$i</span>|grep Leader`<br>  <span class="hljs-keyword">for</span> leader <span class="hljs-keyword">in</span> <span class="hljs-variable">$leaders</span>;<span class="hljs-keyword">do</span><br>    partition=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$leader</span> |awk <span class="hljs-string">&#x27;&#123;print $4&#125;&#x27;</span>`<br>    leader=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$leader</span> |awk <span class="hljs-string">&#x27;&#123;print $6&#125;&#x27;</span>`<br>    <span class="hljs-comment"># 如果需要保证 副分片 和 主分片 不在同一个 Broker 且随机分配在剩余的节点中，可以使用</span><br>    <span class="hljs-comment"># follwer=`grep -vxF $leader ./leaders.txt | shuf -n1`</span><br>    follwer=`grep -vxF <span class="hljs-variable">$leader</span> ./leaders.txt`<br>    follwer1=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$follwer</span> | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>`<br>    follwer2=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$follwer</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&#123;&quot;topic&quot;:&quot;&#x27;</span><span class="hljs-variable">$i</span><span class="hljs-string">&#x27;&quot;,&quot;partition&quot;:&#x27;</span><span class="hljs-variable">$partition</span><span class="hljs-string">&#x27;,&quot;replicas&quot;:[&#x27;</span><span class="hljs-variable">$leader</span><span class="hljs-string">&#x27;,&#x27;</span><span class="hljs-variable">$follwer1</span><span class="hljs-string">&#x27;,&#x27;</span><span class="hljs-variable">$follwer2</span><span class="hljs-string">&#x27;]&#125;,&#x27;</span> &gt;&gt; topic-reassignment.json<br>  <span class="hljs-keyword">done</span><br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;]&#125;&#x27;</span> &gt;&gt; topic-reassignment.json<br></code></pre></td></tr></table></figure><h3 id="扩展副本"><a href="#扩展副本" class="headerlink" title="扩展副本"></a>扩展副本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./kafka-reassign-partitions.sh --zookeeper 192.168.25.123:2181 --reassignment-json-file topic-reassignment.json --execute<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>运维</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kafka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>夜莺Nightingale告警推送Jira</title>
    <link href="/posts/a503d6f5.html"/>
    <url>/posts/a503d6f5.html</url>
    
    <content type="html"><![CDATA[<h2 id="夜莺Nightingale告警推送Jira"><a href="#夜莺Nightingale告警推送Jira" class="headerlink" title="夜莺Nightingale告警推送Jira"></a>夜莺Nightingale告警推送Jira</h2><p><img src="/./images/%E5%A4%9C%E8%8E%BANightingale%E5%91%8A%E8%AD%A6%E6%8E%A8%E9%80%81Jira/image-20230808134528464.png" alt="nightingale"></p><p>最近收到个需求，在处理告警事件中，需要将一级告警推送Jira工单</p><p><strong>夜莺版本：V5.15.0</strong></p><p><strong>开发环境：Golang1.18</strong></p><h4 id="1、server-conf添加相关配置"><a href="#1、server-conf添加相关配置" class="headerlink" title="1、server.conf添加相关配置"></a>1、server.conf添加相关配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs conf">[Jira]<br># Enable<br>Enable = true<br># Jira 地址<br>Url = &quot;https://xxx.com/&quot;<br># Jira 账号<br>BasicAuthUser = &quot;xxx&quot;<br># Jira 密码<br>BasicAuthPass = &quot;xxx&quot;<br># Jira 项目名<br>ProjectName = &quot;xxx&quot;<br># Jira 项目ID<br>ProjectId = &quot;xxx&quot;<br># Issue类型<br>IssueType = &quot;xxx&quot;<br></code></pre></td></tr></table></figure><h4 id="2、-代码修改"><a href="#2、-代码修改" class="headerlink" title="2、 代码修改"></a>2、 代码修改</h4><p>修改src&#x2F;server&#x2F;config&#x2F;config.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go">#添加jira 结构体<br><span class="hljs-keyword">type</span> Jira <span class="hljs-keyword">struct</span> &#123;<br>Enable        <span class="hljs-type">bool</span><br>Url           <span class="hljs-type">string</span><br>BasicAuthUser <span class="hljs-type">string</span><br>BasicAuthPass <span class="hljs-type">string</span><br>ProjectName   <span class="hljs-type">string</span><br>ProjectId     <span class="hljs-type">string</span><br>IssueType     <span class="hljs-type">string</span><br>&#125;<br>#在原有config结构体添加jira<br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>RunMode            <span class="hljs-type">string</span><br>ClusterName        <span class="hljs-type">string</span> <span class="hljs-comment">// 监控对象上报时，指定的集群名称</span><br>BusiGroupLabelKey  <span class="hljs-type">string</span><br>EngineDelay        <span class="hljs-type">int64</span><br>DisableUsageReport <span class="hljs-type">bool</span><br>ReaderFrom         <span class="hljs-type">string</span><br>LabelRewrite       <span class="hljs-type">bool</span><br>ForceUseServerTS   <span class="hljs-type">bool</span><br>Log                logx.Config<br>HTTP               httpx.Config<br>BasicAuth          gin.Accounts<br>SMTP               SMTPConfig<br>Heartbeat          HeartbeatConfig<br>Alerting           Alerting<br>NoData             NoData<br>Redis              storage.RedisConfig<br>DB                 ormx.DBConfig<br>WriterOpt          WriterGlobalOpt<br>Writers            []WriterOptions<br>Reader             PromOption<br>Readers            []PromOption<br>Ibex               Ibex<br>Jira               Jira<br>&#125;<br></code></pre></td></tr></table></figure><p> 在src&#x2F;server&#x2F;common&#x2F;sender&#x2F; 新建jira.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> sender<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;github.com/andygrunwald/go-jira&quot;</span><br><span class="hljs-string">&quot;github.com/didi/nightingale/v5/src/models&quot;</span><br><span class="hljs-string">&quot;github.com/didi/nightingale/v5/src/pkg/tplx&quot;</span><br><span class="hljs-string">&quot;github.com/didi/nightingale/v5/src/server/config&quot;</span><br><span class="hljs-string">&quot;github.com/toolkits/pkg/logger&quot;</span><br><span class="hljs-string">&quot;html/template&quot;</span><br><span class="hljs-string">&quot;io/ioutil&quot;</span><br><span class="hljs-string">&quot;path&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">JiraSender</span><span class="hljs-params">(ctx *models.AlertCurEvent)</span></span> &#123;<br>title := ctx.RuleName<br>tplpath := path.Join(config.C.Alerting.TemplatesDir, <span class="hljs-string">&quot;jira.tpl&quot;</span>)<br>tpl, err := template.New(<span class="hljs-string">&quot;jira.tpl&quot;</span>).Funcs(tplx.TemplateFuncMap).ParseFiles(tplpath)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>logger.Errorf(<span class="hljs-string">&quot;failed to parse tpl: &quot;</span> + tplpath)<br><span class="hljs-keyword">return</span><br>&#125;<br>message := BuildTplMessage(tpl, ctx)<br>auth := jira.BasicAuthTransport&#123;<br>Username: config.C.Jira.BasicAuthUser,<br>Password: config.C.Jira.BasicAuthPass,<br>&#125;<br>jiraClient, err := jira.NewClient(auth.Client(), config.C.Jira.Url)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>logger.Errorf(<span class="hljs-string">&quot;jira_sender: result=fail&quot;</span> + err.Error())<br><span class="hljs-keyword">return</span><br>&#125;<br>owner := ctx.GetTagValue(<span class="hljs-string">&quot;owner&quot;</span>)<br><span class="hljs-keyword">if</span> owner == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>issue := jira.Issue&#123;<br>Fields: &amp;jira.IssueFields&#123;<br>Assignee: &amp;jira.User&#123;<br>Name: owner,<br>&#125;,<br>Description: message,<br>Type: jira.IssueType&#123;<br>Name: config.C.Jira.IssueType,<br>&#125;,<br>Project: jira.Project&#123;<br>Name: config.C.Jira.ProjectName,<br>ID:   config.C.Jira.ProjectId,<br>&#125;,<br>Summary: title,<br>&#125;,<br>&#125;<br>_, res, err := jiraClient.Issue.Create(&amp;issue)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>response, err := ioutil.ReadAll(res.Body)<br>logger.Errorf(<span class="hljs-string">&quot;jira_sender: result=fail&quot;</span>, err, <span class="hljs-type">string</span>(response))<br><span class="hljs-keyword">return</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>logger.Infof(<span class="hljs-string">&quot;jira_sender: result=succ %s: %+v&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改src&#x2F;server&#x2F;engine&#x2F;notify.go</p><p>在send中添加触发推送jira逻辑</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> config.C.Jira.Enable &amp;&amp; event.Severity == <span class="hljs-number">1</span> &amp;&amp; !event.IsRecovered &#123;<br>sender.JiraSender(event)<br>&#125;<br>#是否启用，告警级别是否为<span class="hljs-number">1</span>，告警状态为触发状态<br></code></pre></td></tr></table></figure><h4 id="3、添加jira工单模板"><a href="#3、添加jira工单模板" class="headerlink" title="3、添加jira工单模板"></a>3、添加jira工单模板</h4><p>创建 etc&#x2F;template&#x2F;jira.tpl</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tpl">策略备注：&#123;&#123;.RuleNote&#125;&#125;<br>告警区域：&#123;&#123;.TagsMap.Region&#125;&#125;<br>&#123;&#123;if not .TargetIdent&#125;&#125;告警对象：&#123;&#123;.TargetNote&#125;&#125;&#123;&#123;.TagsMap.container&#125;&#125;&#123;&#123;.TagsMap.topic&#125;&#125;&#123;&#123;.TagsMap.description&#125;&#125;&#123;&#123;end&#125;&#125;<br>&#123;&#123;if .TargetIdent&#125;&#125;告警机器：&#123;&#123;.TargetIdent&#125;&#125; - &#123;&#123;.TargetNote&#125;&#125;&#123;&#123;end&#125;&#125;<br>触发时值：&#123;&#123;.TriggerValue&#125;&#125;<br>触发时间：&#123;&#123;timeformat .TriggerTime&#125;&#125;<br>事件ID：&#123;&#123;.Id&#125;&#125;<br></code></pre></td></tr></table></figure><h4 id="4、编译部署"><a href="#4、编译部署" class="headerlink" title="4、编译部署"></a>4、编译部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">go mod tidy<br>make<br>./n9e server<br></code></pre></td></tr></table></figure><h4 id="5、告警规则修改"><a href="#5、告警规则修改" class="headerlink" title="5、告警规则修改"></a>5、告警规则修改</h4><p>需要推送jira的告警规则需要添加附加标签，附加标签对应jira处理人，告警等级为一级告警</p><p><strong>标签为：owner&#x3D;”xxx”</strong></p><p><img src="/./images/%E5%A4%9C%E8%8E%BANightingale%E5%91%8A%E8%AD%A6%E6%8E%A8%E9%80%81Jira/image-20230808134357465.png" alt="image-20230808134357465"></p><h4 id="6、工单效果"><a href="#6、工单效果" class="headerlink" title="6、工单效果"></a>6、工单效果</h4><p><img src="/./images/%E5%A4%9C%E8%8E%BANightingale%E5%91%8A%E8%AD%A6%E6%8E%A8%E9%80%81Jira/image-20230808134832784.png" alt="image-20230808134832784"></p>]]></content>
    
    
    <categories>
      
      <category>运维</category>
      
    </categories>
    
    
    <tags>
      
      <tag>监控</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafka常用命令</title>
    <link href="/posts/fcfd194a.html"/>
    <url>/posts/fcfd194a.html</url>
    
    <content type="html"><![CDATA[<h2 id="kafka常用命令"><a href="#kafka常用命令" class="headerlink" title="kafka常用命令"></a>kafka常用命令</h2><p><img src="/./images/kafka%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/image-20230808113353843.png" alt="kafka"></p><h3 id="查看topic"><a href="#查看topic" class="headerlink" title="查看topic"></a>查看topic</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-topics.sh  --bootstrap-server xxx:9092 --list<br></code></pre></td></tr></table></figure><h3 id="创建topic"><a href="#创建topic" class="headerlink" title="创建topic"></a>创建topic</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-topics.sh --create  --bootstrap-server xxx:9092 --replication-factor 3 --partitions 3 --topic &lt;topic-name&gt;<br></code></pre></td></tr></table></figure><h3 id="查看指定topic"><a href="#查看指定topic" class="headerlink" title="查看指定topic"></a>查看指定topic</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-topics.sh --bootstrap-server xxx:9092 --describe --topic &lt;topic-name&gt;<br></code></pre></td></tr></table></figure><h3 id="删除指定topic"><a href="#删除指定topic" class="headerlink" title="删除指定topic"></a>删除指定topic</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-topics.sh --bootstrap-server xxx:9092 --delete --topic &lt;topic-name&gt;<br></code></pre></td></tr></table></figure><h3 id="扩展topic的partition数量"><a href="#扩展topic的partition数量" class="headerlink" title="扩展topic的partition数量"></a>扩展topic的partition数量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-topics.sh --bootstrap-server xxx:9092 --topic &lt;topic-name&gt; --alter --partitions 30<br></code></pre></td></tr></table></figure><h3 id="修改topic的过期时间"><a href="#修改topic的过期时间" class="headerlink" title="修改topic的过期时间"></a>修改topic的过期时间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./kafka-configs.sh --zookeeper xxx:2181 --alter --entity-name &lt;topic-name&gt; --entity-type topics --add-config retention.ms=8640000<br></code></pre></td></tr></table></figure><h3 id="扩展topic每个partition的副本数量"><a href="#扩展topic每个partition的副本数量" class="headerlink" title="扩展topic每个partition的副本数量"></a>扩展topic每个partition的副本数量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim xxx.json<br>&#123;&quot;version&quot;:1,<br>&quot;partitions&quot;:[<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:5,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:6,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:7,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:8,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:9,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:10,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:11,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:12,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:13,&quot;replicas&quot;:[0,1,2]&#125;,<br>&#123;&quot;topic&quot;:&quot;&lt;topic-name&gt;&quot;,&quot;partition&quot;:14,&quot;replicas&quot;:[0,1,2]&#125;<br>]&#125;<br>kafka-reassign-partitions.sh --zookeeper xxx:2181 --reassignment-json-file  xxx.json --execute <br></code></pre></td></tr></table></figure><h3 id="查看topic数据大小"><a href="#查看topic数据大小" class="headerlink" title="查看topic数据大小"></a>查看topic数据大小</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-log-dirs.sh \<br>  --bootstrap-server xx:9092 \<br>  --topic-list &lt;topic-name&gt; \<br>  --describe \<br>  | grep -oP &#x27;(?&lt;=size&quot;:)\d+&#x27;  \<br>  | awk &#x27;&#123; sum += $1 &#125; END &#123; print sum &#125;&#x27;<br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">返回结果，单位 Byte</span><br>648<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法二，需要安装 jq</span><br>kafka-log-dirs.sh \<br>    --bootstrap-server xxx:9092 \<br>    --topic-list &lt;topic-name&gt; \<br>    --describe \<br>  | grep &#x27;^&#123;&#x27; \<br>  | jq &#x27;[ ..|.size? | numbers ] | add&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">返回结果，单位 Byte</span><br>648<br></code></pre></td></tr></table></figure><h3 id="列出所有的consumer-group"><a href="#列出所有的consumer-group" class="headerlink" title="列出所有的consumer group"></a>列出所有的consumer group</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-consumer-groups.sh --bootstrap-server xxx:9092 --list<br></code></pre></td></tr></table></figure><h3 id="查看指定consumer-group详情"><a href="#查看指定consumer-group详情" class="headerlink" title="查看指定consumer group详情"></a>查看指定consumer group详情</h3><ul><li>GROUP:消费者 group</li><li>TOPIC:话题 id</li><li>PARTITION:分区 id</li><li>CURRENT-OFFSET:当前已消费的条数</li><li>LOG-END-OFFSET:总条数</li><li>LAG:未消费的条数</li><li>CONSUMER-ID:消费者 id</li><li>HOST:消费者 ip 地址</li><li>CLIENT-ID:客户端 id<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-consumer-groups.sh --bootstrap-server xxx:9092 --describe --group &lt;topic-name&gt;<br></code></pre></td></tr></table></figure></li></ul><h3 id="删除指定consumer-group"><a href="#删除指定consumer-group" class="headerlink" title="删除指定consumer group"></a>删除指定consumer group</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-consumer-groups.sh --bootstrap-server xxx:9092 --delete --group &#123;消费组&#125;<br></code></pre></td></tr></table></figure><h3 id="消费消息"><a href="#消费消息" class="headerlink" title="消费消息"></a>消费消息</h3><p>从头消费</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-console-consumer.sh --bootstrap-server xxx:9092 --topic &lt;topic-name&gt; --from-beginning<br>this is my topic<br></code></pre></td></tr></table></figure><p>从尾消费</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-console-consumer.sh --bootstrap-server 11.8.36.125:9092 --topic &lt;topic-name&gt;  --offset latest  --partition 0 1 2 <br></code></pre></td></tr></table></figure><h3 id="重置消费者offset"><a href="#重置消费者offset" class="headerlink" title="重置消费者offset"></a>重置消费者offset</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-consumer-groups.sh --bootstrap-server xxx:9092 --group my-consumer-group --reset-offsets --execute --to-offset 3 --topic transaction-topic-msg<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>运维</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kafka</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
